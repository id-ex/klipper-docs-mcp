# Техническое задание: MCP-сервер "Klipper-Docs-Local"

## 1. Цель
Предоставление LLM-агенту доступа к документации Klipper. Работа на слабом железе (Raspberry Pi), минимальное потребление RAM/CPU, локальный поиск без внешних API.

## 2. Технический стек
* **Язык:** Python 3.10+.
* **Зависимости:** `mcp` SDK, `git`.
* **Данные:** Локальная папка `docs` (Git Sparse Checkout).
* **Транспорт:** Stdio.

## 3. Функциональные инструменты (Tools)

### 1. `search_docs(query: str)`
* **Логика:** Поиск подстроки в именах файлов и тексте.
* **Ранжирование:** Приоритет совпадениям в названиях файлов и заголовках Markdown (`#`).
* **Выход:** Список (макс. 7 результатов). Каждый включает: путь к файлу и сниппет (150-200 символов вокруг совпадения).

### 2. `read_doc(path: str)`
* **Логика:** Чтение содержимого файла.
* **Безопасность:** Проверка пути через `os.path.commonpath`, запрет выхода за пределы `/docs`.
* **Оптимизация:** Лимит 10 000 символов. Если файл больше — возврат текста с пометкой о наличии продолжения.

### 3. `list_docs_map()`
* **Выход:** Структура (дерево) папок и файлов документации для первичной ориентации агента.

### 4. `sync_docs()`
* **Логика:** Выполнение `git pull --depth 1`.
* **Результат:** Отчет об обновлении файлов.

## 4. Система контроля версий и уведомлений
* **Проверка при старте:**
    1.  Выполнение `git fetch` (без загрузки данных).
    2.  Сравнение хешей: `git rev-parse HEAD` (локальный) и `git rev-parse @{u}` (удаленный).
* **Информирование:**
    * Если хеши не совпадают, сервер добавляет статусное сообщение в `stderr`.
    * Динамическое изменение описания инструмента `sync_docs`: добавление пометки «(РЕКОМЕНДУЕТСЯ: база устарела)».
* **Легковесность:** Проверка не блокирует основной поток сервера.

## 5. Оптимизация под слабое железо
* **Потоковое чтение:** Использование генераторов при поиске, чтобы не загружать все файлы в память.
* **Минимум зависимостей:** Использование встроенных инструментов ОС (`grep` через `subprocess` или стандартный `re`).
* **Отсутствие БД:** Работа напрямую с файловой системой.

## 6. Логика работы суб-агента
1.  Агент получает вопрос.
2.  Вызывает `search_docs` для поиска релевантных файлов по сниппетам.
3.  На основе сниппетов выбирает конкретный файл и вызывает `read_doc`.
4.  Если описания инструментов содержат флаг `outdated`, агент предлагает пользователю запустить `sync_docs`.

